name: 'Local Test - Render Mermaid SVG'

on:
  workflow_dispatch:

jobs:
  test-action:
    name: ${{ matrix.case.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        case:
          - name: 'Basic: Simple MMD'
            input: 'test/fixtures/simple.mmd'
            output: ''
            expected: 'test/fixtures/generated/simple.svg'
          - name: 'Basic: Flowchart MD'
            input: 'test/fixtures/flowchart.md'
            output: ''
            expected: 'test/fixtures/generated/flowchart-1.svg'
          - name: 'Wildcard: Articles'
            input: 'test/fixtures/articles/*'
            output: ''
            expected: 'test/fixtures/articles/generated/article1-1.svg test/fixtures/articles/generated/article2-1.svg test/fixtures/articles/generated/article2-2.svg'
          - name: 'Custom: Output Directory'
            input: 'test/fixtures/custom-output.mmd'
            output: 'test/output'
            expected: 'test/output/custom-output.svg'

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'fix mkdir permissions for act'
        run: chmod -R 777 .

      - name: 'Run Action'
        uses: ./
        with:
          input-files: ${{ matrix.case.input }}
          output-dir: ${{ matrix.case.output }}

      - name: 'Verify generated files'
        run: |
          echo "Checking for expected files: ${{ matrix.case.expected }}"
          for file in ${{ matrix.case.expected }}; do
            if [ -f "$file" ]; then
              echo "✓ $file found"
              if grep -q '<svg' "$file" && grep -q '</svg>' "$file"; then
                echo "✓ $file is valid SVG"
              else
                echo "✗ $file is NOT valid SVG"
                exit 1
              fi
            else
              echo "✗ $file NOT found"
              exit 1
            fi
          done

      - name: 'Display test results'
        if: always()
        run: |
          echo "=== Test Summary ==="
          echo "Generated files:"
          find test -name "*.svg" -type f || echo "No SVG files found"
